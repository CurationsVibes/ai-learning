name: Auto-label Pull Requests

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

permissions:
  contents: read
  pull-requests: write

jobs:
  label:
    name: Apply labels based on file changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Apply labels
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml
          sync-labels: true

      - name: Comment on PR with applied labels
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name);

            if (labels.length === 0) {
              console.log('No labels were applied');
              return;
            }

            // Group labels by category
            const agentLabels = labels.filter(l => l.startsWith('agent:'));
            const phaseLabels = labels.filter(l => l.startsWith('phase:'));
            const contentLabels = labels.filter(l => l.startsWith('content:'));
            const typeLabels = labels.filter(l => l.startsWith('type:'));
            const priorityLabels = labels.filter(l => l.startsWith('priority:'));
            const statusLabels = labels.filter(l => l.startsWith('status:'));
            const specialLabels = labels.filter(l => l.startsWith('special:'));

            let comment = '## ðŸ¤– Auto-labeler Results\n\n';
            comment += 'The following labels have been automatically applied based on your changes:\n\n';

            if (agentLabels.length > 0) {
              comment += `**ðŸ¤– Agent**: ${agentLabels.map(l => `\`${l}\``).join(', ')}\n`;
            }
            if (phaseLabels.length > 0) {
              comment += `**ðŸ“Š Phase**: ${phaseLabels.map(l => `\`${l}\``).join(', ')}\n`;
            }
            if (contentLabels.length > 0) {
              comment += `**ðŸ“š Content**: ${contentLabels.map(l => `\`${l}\``).join(', ')}\n`;
            }
            if (typeLabels.length > 0) {
              comment += `**ðŸ”§ Type**: ${typeLabels.map(l => `\`${l}\``).join(', ')}\n`;
            }
            if (priorityLabels.length > 0) {
              comment += `**ðŸš¨ Priority**: ${priorityLabels.map(l => `\`${l}\``).join(', ')}\n`;
            }
            if (statusLabels.length > 0) {
              comment += `**ðŸ”„ Status**: ${statusLabels.map(l => `\`${l}\``).join(', ')}\n`;
            }
            if (specialLabels.length > 0) {
              comment += `**â­ Special**: ${specialLabels.map(l => `\`${l}\``).join(', ')}\n`;
            }

            comment += '\n---\n';
            comment += 'ðŸ’¡ **Tip**: You can manually add or remove labels if needed.\n';
            comment += 'ðŸ“– See [Label Taxonomy](/.agent-coordination/AUTOMATION_IMPROVEMENTS.md) for descriptions.';

            // Only post comment if labels were actually applied
            if (labels.length > 0) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
