---
interface Props {
  itemId: string;
  itemType?: 'code' | 'topic' | 'cookbook' | 'section';
  showUsageCheck?: boolean;
}

const { itemId, itemType = 'topic', showUsageCheck = true } = Astro.props;
---

<div class="upvote-widget" data-item-id={itemId} data-item-type={itemType}>
  <button class="upvote-button" title="Upvote this content">
    <svg class="upvote-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 4L14.5 9.5L20.5 10.5L16 15L17 21L12 18L7 21L8 15L3.5 10.5L9.5 9.5L12 4Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
    </svg>
    <span class="upvote-count">0</span>
  </button>
  
  {showUsageCheck && (
    <button class="usage-button" title="Mark as used/learned">
      <svg class="check-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M5 13L9 17L19 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="usage-text">Used</span>
    </button>
  )}
  
  <div class="usage-stats">
    <span class="stat-item" title="Total upvotes">
      <span class="stat-icon">üëç</span>
      <span class="stat-value upvote-stat">0</span>
    </span>
    <span class="stat-item" title="Users who used this">
      <span class="stat-icon">‚úì</span>
      <span class="stat-value usage-stat">0</span>
    </span>
  </div>
</div>

<script>
  // Store votes in localStorage
  const STORAGE_KEY_PREFIX = 'curator-hub-';
  
  interface ItemData {
    upvotes: number;
    usageCount: number;
    userUpvoted: boolean;
    userUsed: boolean;
  }
  
  function getItemData(itemId: string): ItemData {
    const key = `${STORAGE_KEY_PREFIX}${itemId}`;
    const stored = localStorage.getItem(key);
    if (stored) {
      return JSON.parse(stored);
    }
    return {
      upvotes: 0,
      usageCount: 0,
      userUpvoted: false,
      userUsed: false
    };
  }
  
  function setItemData(itemId: string, data: ItemData): void {
    const key = `${STORAGE_KEY_PREFIX}${itemId}`;
    localStorage.setItem(key, JSON.stringify(data));
  }
  
  function updateWidget(widget: HTMLElement, data: ItemData): void {
    const upvoteButton = widget.querySelector('.upvote-button');
    const usageButton = widget.querySelector('.usage-button');
    const upvoteCount = widget.querySelector('.upvote-count');
    const upvoteStat = widget.querySelector('.upvote-stat');
    const usageStat = widget.querySelector('.usage-stat');
    
    if (upvoteCount) upvoteCount.textContent = String(data.upvotes);
    if (upvoteStat) upvoteStat.textContent = String(data.upvotes);
    if (usageStat) usageStat.textContent = String(data.usageCount);
    
    if (upvoteButton) {
      upvoteButton.classList.toggle('active', data.userUpvoted);
    }
    
    if (usageButton) {
      usageButton.classList.toggle('active', data.userUsed);
    }
  }
  
  // Initialize all widgets
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.upvote-widget').forEach((widget) => {
      const itemId = widget.getAttribute('data-item-id');
      if (!itemId) return;
      
      const data = getItemData(itemId);
      updateWidget(widget as HTMLElement, data);
      
      // Handle upvote button
      const upvoteButton = widget.querySelector('.upvote-button');
      upvoteButton?.addEventListener('click', () => {
        const currentData = getItemData(itemId);
        currentData.userUpvoted = !currentData.userUpvoted;
        currentData.upvotes += currentData.userUpvoted ? 1 : -1;
        setItemData(itemId, currentData);
        updateWidget(widget as HTMLElement, currentData);
        
        // Add animation
        upvoteButton.classList.add('pulse');
        setTimeout(() => upvoteButton.classList.remove('pulse'), 300);
      });
      
      // Handle usage button
      const usageButton = widget.querySelector('.usage-button');
      usageButton?.addEventListener('click', () => {
        const currentData = getItemData(itemId);
        currentData.userUsed = !currentData.userUsed;
        currentData.usageCount += currentData.userUsed ? 1 : -1;
        setItemData(itemId, currentData);
        updateWidget(widget as HTMLElement, currentData);
        
        // Add animation
        usageButton.classList.add('pulse');
        setTimeout(() => usageButton.classList.remove('pulse'), 300);
      });
    });
  });
</script>

<style>
  .upvote-widget {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    background: rgba(0, 0, 0, 0.02);
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 0.5rem;
    margin: 0.5rem 0;
  }

  .upvote-button,
  .usage-button {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.375rem 0.75rem;
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.875rem;
    color: #666;
  }

  .upvote-button:hover,
  .usage-button:hover {
    background: rgba(99, 102, 241, 0.05);
    border-color: rgba(99, 102, 241, 0.3);
    transform: translateY(-2px);
  }

  .upvote-button.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: transparent;
  }

  .usage-button.active {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border-color: transparent;
  }

  .upvote-button.active .upvote-icon,
  .usage-button.active .check-icon {
    fill: currentColor;
  }

  .upvote-button.pulse,
  .usage-button.pulse {
    animation: pulse 0.3s ease;
  }

  @keyframes pulse {
    0%, 100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.1);
    }
  }

  .upvote-icon,
  .check-icon {
    width: 16px;
    height: 16px;
    transition: fill 0.2s ease;
  }

  .upvote-count {
    font-weight: 600;
    min-width: 1.5rem;
    text-align: center;
  }

  .usage-text {
    font-weight: 600;
  }

  .usage-stats {
    display: flex;
    gap: 0.75rem;
    margin-left: 0.5rem;
    padding-left: 0.75rem;
    border-left: 1px solid rgba(0, 0, 0, 0.1);
  }

  .stat-item {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.75rem;
    color: #666;
  }

  .stat-icon {
    font-size: 0.875rem;
  }

  .stat-value {
    font-weight: 600;
    min-width: 1.25rem;
    text-align: center;
  }

  @media (max-width: 640px) {
    .upvote-widget {
      flex-wrap: wrap;
      width: 100%;
    }

    .usage-stats {
      width: 100%;
      margin-left: 0;
      padding-left: 0;
      border-left: none;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
      padding-top: 0.5rem;
      margin-top: 0.5rem;
    }
  }
</style>
